Global Sensitivity Analysis of Demographic Models using demgsa
========================================================
Author: Matthew Aiello-Lammens
Date: 2015-04-21

# Overview

This tutorial goes through how to use the `demgsa` package to perform a global
sensitivity analysis (GSA) of a demographic model constructed using the 
[RAMAS GIS](http://ramas.com/software.htm) Software. `demgsa` includes 
functions to make easier each major step of a GSA:

1. Creation of new demographic models parameterized with random sets of values,
which represent the uncertainty and/or stochasticity inherent in each parameter.
2. Creation of scripts to batch run RAMAS GIS models.
3. Reading and collating of model inputs and results for further analysis.

Using these results, we can examining the uncertainty of the input parameters 
and the variability of various end-point metrics (e.g., Quasi-extinction 
measures and Expected Minimum Abundance values), and assess the relative 
importance of this uncertainty.

In addition, in this tutorial, we demonstrate how to use paired simulations to
carry out impact assessments. Using this method it is possible to evaluate the
affect of environmental impacts (e.g., global climate change) or changes to 
model structure (e.g., changes to density dependence assumptions) on model
outcomes.

## Parameters allowed to vary in version 0.1.0 of demgsa

The following parameters are allowed to vary in the current implementation
of `demgsa`.

* Each element of the stage/age matrix (i.e. survival and fecundity)
* Each element of the stage/age standard deviation matrix 
(i.e. variability in survival and fecundity)
* Dispersal Rates
  * Each element of the dispersal-distance function (all varied using **One** 
  random variable)
  * Each element of the dispersal matrix, either each independently or all 
  dependently (user determined)
  * Discretely between DCH scenarios (includes discrete selection of Dispersal 
  Matrix as well)
* Inter-population Correlation
  * Each element of the correlation-distance function (all varied using **One** 
  random variable)
  * Each element of the correlation matrix (all varied using **One** random 
  variable)
* Stage Initial Abundance Distribution Values
  * User can select use of Stable Age Distribution, as determined by the matrix 
  elements
  * User can allow stage initial abundance distribution values to vary - actual 
  initial abundance 
  values are varied else where in the script
* Population Initial Abundance - All populations varied using **One** random 
value
* Population specific Rmax - All populations varied using **One** random value
* Population Carrying Capacity
  * KCH files chosen discretely between scenarios using **One** random value

# Initial set-up

## Install the `demgsa` package

Currently the `demgsa` package is available via [github](https://github.com/). 
The easiest way to install this package is to use the 
[devtools](https://github.com/hadley/devtools) package.


```{r}
## Check for devtools. Install if not already installed.
if( !( "devtools" %in% installed.packages() ) ){
  install.packages( "devtools" ) 
}

## Load devtools package
library( devtools )

## Check for demgsa. Install if not already installed
if( !( "demgsa" %in% installed.packages() ) ){
  devtools::install_github( "mlammens/demgsa" ) 
}

## Load demgsa package
library( demgsa )
```

## demgsa Functions

If you successfully carried out the above steps, then you can now use any of
the `demgsa` functions. While a simple sensitivity
analysis will require the user to call only one of these functions 
(`sensitivity`), the other functions
can also be used on their own to:

* Determine which Metapop version was used to create a particular *.mp file
* Read a *.mp file and store it's contents in a list structure
* Read a *.ptc file
* Write a new *.mp file, in the event that you adjusted a file you read in

# Running a Sensitivity Analysis

## Metapop File Preparation

To run a GSA, the user supplies at least two *.mp files, 
one of which has all of the lowest estimates for any uncertain parameters 
and the other which has all of the highest estimates for any uncertain 
parameters.  Note that this is different than  ‘best case’ and ‘worst case’ 
scenario *.mp files.  Some high values for parameters may be 
associated with a ‘worst case’ scenario (e.g., correlation 
structure among populations), which would include low values of 
other parameters (e.g., survival or fecundity). The 
[demgsa GitHub repository](https://github.com/mlammens/demgsa) contains all of 
the files need to work through this tutorial, including sample *mp files, in 
the `inst/extdata` directory. 

## Modifying the sens_config.txt file

Once the `demgsa` package is installed on loaded into your R workspace, you are
ready to run a GSA on your demographic model. The next step is to modify the
configuration file to match your specific demographic model parameters. A
template file can be found in the `demgsa` GitHub repository 
[here](https://github.com/mlammens/demgsa/blob/master/inst/extdata/sens_config.txt).
Each of the parameters that needs to be set is described in this sens_config.txt 
file. 
This is a template file that can be copied and modified to setup
the configurations of individual sensitivity runs.  Step through this 
file and read all of the material in it.  
The template is parameterized to run the sample model examined in this 
tutorial, which is a demographic model of the Florida Snowy Plover[^1]. During
these first steps, we carry out a GSA on a model with no effect of sea-level
rise.

[^1]: Aiello-Lammens et al. 2011. The impact of sea‐level rise on Snowy Plovers in Florida: integrating geomorphological, habitat, and metapopulation models. Global Change Biology 17(12): 3644-3654


### Special cases for varying Carrying Capacity and Migration (Dispersal) scenarios

More than two *.mp files can be used to test uncertainty in changes through 
time of carrying capacity 
or dispersal parameters. In RAMAS Metapop, these changes are implemented 
via change files, or *.?CH files.  For example, for the Snow Plover 
example used here, we incorporated changes to 
population carrying capacity resulting from forecasted sea-level rise, 
using RAMAS GIS to create a spatially dynamic demographic model in which 
population carrying capacity decreases over the course of the simulation. 
The population carrying capacities for each patch is stored in *.KCH 
files (one per patch). We generated three
carrying capacity change scenarios (Low, Medium, and High carrying capacities). 
In carrying out a sensitivity analysis, we choose one of these 
three scenarios at random to accompany the other randomly 
chosen parameter values.  A similar method can be implemented to vary 
Migration (Dispersal) scenarios, which may change through time in a 
dynamic spatial model as well, as populations change in size 
and distance from each other, or shift in space. 

## Step 1. Creation of new demographic models parameterized with random sets of values

The first step of this GSA is to create new *mp files 
parameterized with random sets of values,
which represent the uncertainty and/or stochasticity inherent in each parameter.
This is done using the `sensitivity` function. The argument to the
`sensitivity` function is the sens_config txt file. For the no climate change
(i.e., no slr) scenario, the associated file is sens\_config\_nocc.txt.

To complete this tutorial on your own system, change into the working directory
were the files from the `inst/extdata` directory are stored.

```{r}
## Set working directory
setwd( "inst/extdata/" )

## Call the sensitivity function using the sens_config file for nocc
sensitivity( "sens_config_nocc.txt" )
```


This example requires that we account for changes in carrying capacity
through time (*.KCH - see above).  Here are some key differences between 
this run and the 'simple' example above:

* We have two sets of *.mp files, one associated with no sea-level rise (SLR) and
the other associated with 2M of SLR
* Here we have **three** \*.mp files, to allow for three KCH scenarios
*within* each SLR treatment

### How do we adjust the sens.config file?

* We will need two different sens.config files
* Add three *.mp files
* Set `pop.kch.include = TRUE`
* To compare 2M and No SLR, set `use.rv.file = TRUE` for the 
**second** analysis (let's do No SLR first, then 2M)


# Extracting information from *.mp files

The process entails using the following scripts:
* mp.read.results.r
* mp.results.r
* mp.mult.results.r

Go through example of doing this.

## mp.mult.results.r 

Needs a text file of all of the *.mp files you want to extract
information from.  

# Modifying the SA Scripts

### Why?

* Account for parameters not currently varied
  * User defined Density Dependence values
  * Other values in the 'Population Specific' parameters
  * Management actions
* Incorporate a user defined randomization method (i.e. something other than
urand or LHS)
* There are many reasons you may want to vary the code that I can't think of

### Note

The most likely scripts that will need to be modified are those pertaining 
to results extraction. There are several different versions of the `mp.mult.results.r`
script floating around the Akcakaya lab right now! 
(i.e. one for NASA, one for SNPL, etc.)

### Fork (or Copy)

* Always keep a **working** copy of the SA scripts
* When planning to make changes to the SA code, make a copy of the directory
in a new location and work on that copy
* If the change is something to add to the main scripts, merge them later after
testing


